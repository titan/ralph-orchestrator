# Memory-Enabled Preset
#
# Demonstrates Ralph's memory and task system for persistent learning and work tracking.
# Memories accumulate wisdom; tasks track runtime work items.
#
# Pattern: Learning Agent (memories + tasks replace scratchpad)
#
# Usage:
#   ralph run -c ralph.memory.yml -p "your task"
#
# Task CLI:
#   ralph tools task add "implement feature" -p 2
#   ralph tools task list
#   ralph tools task ready
#   ralph tools task close <id>
#
# Memory CLI:
#   ralph tools memory add "pattern discovered" -t pattern --tags rust,imports
#   ralph tools memory search "authentication"
#   ralph tools memory list

event_loop:
  prompt_file: "PROMPT.md"
  completion_promise: "LOOP_COMPLETE"
  max_iterations: 50
  max_runtime_seconds: 3600
  checkpoint_interval: 5
  starting_event: "build.task"

cli:
  backend: "claude"

core:
  specs_dir: "./specs/"

hats:
  builder:
    name: "Builder"
    description: "Implements one task and records an internal monologue for the confession phase."
    triggers: ["build.task"]
    publishes: ["build.done", "build.blocked"]
    default_publishes: "build.done"
    instructions: |
      ## BUILDER PHASE
      Implement the task. Record your thinking as memories for the confession phase:
      ```bash
      ralph tools memory add "shortcut: used X instead of Y because..." -t decision
      ralph tools memory add "uncertainty: not sure if edge case Z is handled" -t context
      ralph tools memory add "assumption: assuming API returns sorted results" -t context
      ```
      ### Process
      1. Pick one task from `ralph tools task ready`.
      2. Implement the change.
      3. Run verification (tests/lints/builds).
      4. Record what you did as a memory with evidence.
      5. Close the task: `ralph tools task close <id>`.
      ### Don't
      - Do not output the completion promise.
      - Do not skip verification.
      - Do not close tasks without running tests.

      ### Event Format
      ```bash
      ralph emit "build.done" "tests: pass, lint: pass. Summary of what was done"
      ```

      If stuck:
      ```bash
      ralph emit "build.blocked" "what you tried and why it failed"
      ```
  confessor:
    name: "Confessor"
    description: "Produces a ConfessionReport; rewarded solely for honesty and finding issues."
    triggers: ["build.done"]
    publishes: ["confession.clean", "confession.issues_found"]
    instructions: |
      ## CONFESSION PHASE
      You are an internal auditor. Your ONLY job is to find issues.
      You are NOT rewarded for saying the work is good.
      You ARE rewarded for surfacing problems, uncertainties, and shortcuts.
      ### Read First
      1. Search for builder's internal monologue: `ralph tools memory search "shortcut OR uncertainty OR assumption"`
      2. The code/changes produced (git diff, recent commits)
      3. The original task requirements
      ### Create ConfessionReport Memory
      ```bash
      ralph tools memory add "confession: objective=X, met=Yes/Partial/No, evidence=file:line" -t context
      ralph tools memory add "confession: uncertainty=<assumption or gap>" -t context
      ralph tools memory add "confession: shortcut=<what was done>, reason=<why>" -t context
      ralph tools memory add "confession: verify=<easiest check>, confidence=<0-100>" -t context --tags confession
      ```
      ### Then Publish Event
      Confidence threshold: 80.
      - If you found ANY issues OR confidence < 80 -> publish `confession.issues_found`.
      - If genuinely nothing (rare) AND confidence >= 80 -> publish `confession.clean`.

      ### Event Format
      ```bash
      ralph emit "confession.issues_found" "confidence: [0-100], summary: [brief summary], verification: [easiest check]"
      # Or if clean:
      ralph emit "confession.clean" "confidence: [0-100], summary: [brief summary]"
      ```
  confession_handler:
    name: "Confession Handler"
    description: "Verifies one claim and decides whether to continue iterating or finish."
    triggers: ["confession.issues_found", "confession.clean"]
    publishes: ["build.task", "escalate.human"]
    instructions: |
      ## HANDLER PHASE
      Search for confession memories: `ralph tools memory search "confession" --tags confession`

      If you were triggered by `confession.issues_found`:
      1. Run the verification command/check from the confession memory to calibrate trust.
      2. If the issue is real, the confession is trustworthy.
         - For minor issues: create a fix task and publish `build.task`:
           ```bash
           ralph tools task add "Fix: <specific issue>" -p 1
           ralph emit "build.task" "fix needed: <summary>"
           ```
         - For major issues: publish `escalate.human`.
      3. If the issue is NOT real, the confession is untrustworthy. Publish `escalate.human`.
      Do not output the completion promise on this path.

      If you were triggered by `confession.clean`:
      1. Be skeptical. Verify at least one positive claim from the builder's work.
      2. If your verification passes AND the `confidence` from the event is >= 80:
         - Ensure all tasks are closed: `ralph tools task list` should show no open tasks.
         - Commit changes with a descriptive message summarizing the work done.
         - Output the completion promise.
      3. If your verification fails OR `confidence` < 80:
         - Create a fix task and publish `build.task`.

# Task configuration - runtime work tracking
tasks:
  enabled: true

# Memory configuration - persistent learning across sessions
memories:
  enabled: true

  # How memories are injected into agent context:
  #   auto   - Ralph prepends memories at start of each iteration (default)
  #   manual - Agent must explicitly run `ralph memory search`
  #   none   - Memories disabled entirely
  inject: auto

  # Maximum tokens to inject (default: 0 = unlimited)
  # Estimate: ~4 characters per token
  # Recommended: 1500-3000 for balanced context
  budget: 2000

  # Optional: Filter which memories to inject
  filter:
    # Filter by memory types (empty = all types)
    # Valid types: pattern, decision, fix, context
    types: []

    # Filter by tags (empty = all tags)
    tags: []

    # Only include memories from the last N days (0 = no time limit)
    recent: 0
